# MVP: Приложение-анализатор чеков Biedronka
## 1. Цели MVP (Минимально жизнеспособный продукт)
-   **Вход:** PDF-файлы чеков Biedronka с текстовым слоем.
-   **Выход:**
    -   Список чеков за выбранный месяц.
    -   График "Расходы по месяцам" (до 12 последних месяцев).
    -   Ключевые показатели: максимальный чек, общая сумма за месяц, топ-категории.
-   **Хранение и анализ:** Локально на устройстве (SQLite).
-   **Язык интерфейса:** EN (с планами на PL/RU).
-   **Приватность:** Данные не шифруются, без PIN.
-   **Телеметрия:** Sentry только для крашей и производительности (без PII), с возможностью отключения.

---
## 2. Технический стек (все компоненты бесплатные)
-   **Основа:** Flutter (stable), Dart.
-   **Управление состоянием:** Riverpod (опционально Riverpod Generator).
-   **Навигация:** go_router.
-   **База данных:** sqflite (+ sqlite3 FFI для десктоп-тестов, опционально).
-   **Графики:** fl_chart.
-   **Импорт файлов:** file_picker (с использованием SAF на Android).
-   **Фоновые задачи:** workmanager.
-   **Мониторинг:** sentry_flutter (free-tier).
-   **Работа с датами:** intl.
-   **Модели данных:** freezed/collection (опционально).

---
## 3. Архитектура приложения (по слоям)
### 3.1. Presentation (UI)
-   **Экраны:**
    -   **Dashboard:** KPI (Total/Avg/Count за месяц), график месячных трат, кнопка выбора месяца.
    -   **Month:** Список чеков, мини-график по категориям.
    -   **Receipt:** Детализация позиций чека.
    -   **Import:** Выбор PDF, очередь импорта, статусы.
    -   **Settings:** Настройка Sentry, информация о приложении.
-   **Паттерн:** MVU/MVVM с использованием Riverpod (StateNotifier/AsyncValue). Логика вынесена в провайдеры/юзкейсы.

### 3.2. Application (Use Cases)
-   **Операции:**
    -   `ImportReceiptsFromPdf`
    -   `ParseReceiptText`
    -   `UpsertReceipt` (вставка или обновление чека)
    -   `GetMonthlyTotals` (для графика)
    -   `GetMonthOverview` (итоги, топ-категории)
    -   `GetMaxReceiptForMonth`
    -   `GetReceiptsByMonth`
    -   `DetectDuplicates`
    -   `CategorizeLineItems`
-   **Особенности:** Композиция через провайдеры Riverpod, каждая операция `async` и `cancelable`.

### 3.3. Domain (Модели и правила)
-   **Модели:** `Receipt`, `LineItem`, `Merchant`, `Category`.
-   **Правила:**
    -   **Денежные значения:** `Decimal` или `num` с нормализацией польской запятой (`,` -> `.`).
    -   **Скидки:** Отдельные строки `RABAT`/`Promocja` привязываются к позициям.
    -   **Возвраты:** Отрицательные позиции.
    -   **Дубликаты:** Идентификация по хэшу файла и эвристикам (`fileHash` + дата/сумма/магазин).

### 3.4. Data (Хранилище)
-   **SQLite:**
    -   **Таблицы:** `receipts`, `line_items`, `merchants`, `categories`.
    -   **Индексы:** `receipts(purchase_ts)`, `receipts(total_gross)`, `line_items(receipt_id)`.
    -   **Материализованные таблицы:** `monthly_totals`, `category_month_totals` для ускорения агрегации.
-   **Репозитории:** `ReceiptRepo`, `LineItemRepo`, `MerchantRepo`, `CategoryRepo`, `AnalyticsRepo`.

### 3.5. Platform (Интеграции)
-   **PDF-парсер:** Platform channel для нативной обёртки над Apache PDFBox (Android). Функции: `extractTextPages`, `getMetadata`.
-   **Доступ к файлам:** `file_picker` для выбора, копирование в область хранения приложения (app-scoped storage) для постоянного доступа.
-   **Фоновые задачи:** `workmanager` для пакетной обработки PDF.
-   **Sentry:** Инициализация и сбор `breadcrumbs` (без конфиденциальных данных).

---
## 4. Конвейер данных (E2E)
-   **1.** Выбор PDF → копирование в `app storage`.
-   **2.** **Извлечение текста:** `PdfTextExtractor` постранично.
-   **3.** **Нормализация текста:** `NFC`, удаление переносов, унификация разрывов строк, замена запятых.
-   **4.** **Детектор формата:** Поиск характерных строк (`Paragon fiskalny`, `NIP` и т.д.).
-   **5.** **Парсер:** Извлечение заголовка, позиций, итогов.
-   **6.** **Категоризация:** Использование словаря с польскими ключевыми словами (`mleko`, `pieczywo`).
-   **7.** **Дедупликация:** Сравнение по хэшу и эвристикам.
-   **8.** **Сохранение:** Запись в таблицы `receipts`/`line_items` и обновление агрегатов.
-   **9.** **Аналитика:** Отображение данных на `Dashboard` и `Month` экранах.

---
## 5. UX-потоки (минимум)
-   **Onboarding:** Приветственный экран с ключевой информацией о приложении.
-   **Import:** Одна кнопка импорта, список статусов.
-   **Dashboard:** График + KPI + кнопка.
-   **Month:** Список чеков.
-   **Receipt:** Детализация чека с кнопкой "Open PDF".

---
## 6. Нефункциональные требования
-   **Производительность:** Импорт одного PDF ≤ 1-2 секунды; рендеринг графиков < 16 мс.
-   **Устойчивость:** Фоновые задачи с повторами, идемпотентные обновления данных.
-   **Размер:** Допустимо увеличение за счёт PDFBox (~8-12 МБ на Android).
-   **Логи:** Без сохранения содержимого чеков.

---
## 7. Тест-план
-   **Юнит-тесты:** Нормализация текста, парсинг, категоризация.
-   **Интеграционные тесты:** Полный цикл импорта, дедупликация.
-   **Golden-тесты:** Скриншоты UI для `Dashboard`, `Month`, `Receipt`.
-   **Тесты производительности:** Бенчмарки для импорта.

---
## 8. Последовательность имплементации (итеративно)
-   **Этап 0 (0,5 дня):** Инициализация проекта, подключение зависимостей.
-   **Этап 1 (1 день):** Проектирование схемы БД и интерфейсов репозиториев.
-   **Этап 2 (1–1,5 дня):** Реализация нативной части для извлечения текста из PDF (Android).
-   **Этап 3 (1–1,5 дня):** Создание модуля парсера чеков Biedronka.
-   **Этап 4 (1 день):** Реализация импорта и дедупликации.
-   **Этап 5 (0,5–1 день):** Разработка агрегатов и аналитических Use Cases.
-   **Этап 6 (1,5–2 дня):** Создание UI для всех основных экранов.
-   **Этап 7 (1–1,5 дня):** Написание тестов и стабилизация.
-   **Этап 8 (0,5 дня):** Подготовка к релизу MVP.

---
## 9. Риски и план «Б»
-   **"Грязный" текст в PDF:** Улучшение правил нормализации, использование более сложных настроек PDFBox.
-   **Большие PDF:** Внедрение постраничного парсинга и прогресс-бара.
-   **Низкая производительность SQLite:** Уже предусмотрены индексы и материализованные таблицы.
-   **Низкая точность категорий:** Показ категории "Other" с возможностью пользовательской категоризации в будущем.